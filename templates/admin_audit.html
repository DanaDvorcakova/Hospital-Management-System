{% extends "base.html" %}

{% block title %}Audit Log{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>üõ°Ô∏è Audit Log</h2>
    <!-- Clear Audit Log Button triggers modal -->
     <button type="button" class="btn btn-danger btn-clear-log" data-bs-toggle="modal" data-bs-target="#clearAuditLogModal">
        Clear Audit Log
    </button>
</div>

<!-- Search Box for filtering audit log entries -->
<div class="row">
    <div class="col-12 col-md-8 col-lg-6">
        <input id="auditLogSearch" class="form-control mb-3" type="text" placeholder="Search by role or action">
    </div>
</div>

 <!-- Audit Log Table -->
<table class="table table-striped table-bordered align-middle" id="auditTable">
    <thead class="table">
        <tr>
            <th data-column="0" class="filterable">No</th>
            <th data-column="1" class="filterable">User ID</th>
            <th data-column="2" class="filterable">Username</th>
            <th data-column="3" class="filterable">Role</th>
            <th data-column="4" class="filterable">Action</th>
            <th data-column="5" class="filterable">Timestamp</th>
        </tr>
    </thead>
    <tbody>
        <!-- Loop through each log entry and display it -->
    {% for log in logs %}
        <tr>
            <td>{{ loop.index }}</td>
            <td>{{ log.user_id or "-" }}</td>

<td>
    <!-- Username with links to relevant pages based on user role -->
    {% if log.role == "admin" %}
        <a href="{{ url_for('admin_index') }}" class="text-decoration-none fw-semibold">{{ log.username }}</a>
    {% elif log.role == "doctor" and log.user_id %}
        <a href="{{ url_for('admin_doctors') }}" class="text-decoration-none fw-semibold">{{ log.username }}</a>
    {% elif log.role == "patient" and log.user_id %}
        <a href="{{ url_for('admin_patients') }}" class="text-decoration-none fw-semibold">{{ log.username }}</a>
    {% else %}
        <!-- Only show plain username if it's not linked -->
        {{ log.username }}
    {% endif %}
</td>

    

            <td><span class="badge bg-secondary text-uppercase">{{ log.role or "system" }}</span></td>
            <td><span class="audit-action" data-action="{{ log.action|lower }}">{{ log.action }}</span></td>
            <td>{{ log.timestamp.strftime("%Y-%m-%d %H:%M:%S") }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% set paginator = logs %}
{% set endpoint = 'admin_audit' %}
{% include 'pagination.html' %}

<!-- Clear Audit Log Modal -->
<div class="modal fade" id="clearAuditLogModal" tabindex="-1" aria-labelledby="clearAuditLogLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="clearAuditLogLabel">Clear Audit Log</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Warning message about deleting all logs -->
        Are you sure you want to <strong>delete all audit log entries</strong>?<br>
        This action <strong>cannot be undone</strong>.
      </div>
      <div class="modal-footer">
         <!-- Cancel button to close the modal -->
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <!-- Form to submit the action of clearing the audit log -->
        <form method="POST" action="{{ url_for('clear_audit_log') }}">
            <button type="submit" class="btn btn-danger">Clear Audit Log</button>
        </form>
      </div>
    </div>
  </div>
</div>


{% endblock %}


